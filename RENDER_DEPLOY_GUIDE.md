# ğŸš€ Render Deployment Fix Guide

## âŒ Why Render Was Failing

Your Render deployments were failing with:
```
Deploy failed for <commit>: Exited with status 1 while building your code.
```

**Root Cause**: Render was trying to build your entire Next.js/Vercel app instead of a simple Node.js service. Next.js requires Vercel-specific features that don't exist in Render's environment.

## âœ… The Solution

Created a dedicated **lightweight microservice** in `render-pdf-service/` that:
- Runs a simple Express server
- Uses Puppeteer to generate PDFs
- Has NO Next.js, React, or Vercel dependencies
- Installs Chromium via `apt.txt`

## ğŸ“ What Was Created

```
clinicalscribe/
â”œâ”€â”€ render-pdf-service/        â† New folder
â”‚   â”œâ”€â”€ package.json           â† Minimal dependencies (express + puppeteer)
â”‚   â”œâ”€â”€ server.js              â† Simple Express server with /api/pdf/render
â”‚   â”œâ”€â”€ apt.txt                â† System packages (Chromium, fonts, etc.)
â”‚   â”œâ”€â”€ README.md              â† Deployment instructions
â”‚   â””â”€â”€ .gitignore
```

## ğŸ”§ Deploy to Render (Step-by-Step)

### 1. Push to GitHub
```bash
git add render-pdf-service/
git commit -m "feat: add dedicated render pdf service"
git push
```

### 2. Create Render Service
1. Go to [render.com](https://render.com/dashboard)
2. Click **New** â†’ **Web Service**
3. Connect your GitHub account (if not already)
4. Select your `clinicalscribe` repository

### 3. Configure Service
**CRITICAL**: Set these values correctly:

| Setting | Value |
|---------|-------|
| **Name** | `clinicalscribe-pdf-service` |
| **Root Directory** | `render-pdf-service` â† **MUST SET THIS** |
| **Environment** | `Node` |
| **Build Command** | `npm install` |
| **Start Command** | `npm start` |
| **Instance Type** | Free (or Starter for $7/mo) |

### 4. Deploy
Click **Create Web Service** and wait ~2-3 minutes.

### 5. Verify Deployment
Once deployed, you'll see:
```
ğŸš€ PDF service running on port 10000
```

Visit your service URL (e.g., `https://clinicalscribe-pdf-service.onrender.com`) and you should see:
```
âœ… ClinicalScribe PDF Service Online
```

## ğŸ”— Connect to Your Main App

### 1. Copy Your Render URL
Example: `https://clinicalscribe-pdf-service.onrender.com`

### 2. Add to Vercel Environment Variables
1. Go to [Vercel Dashboard](https://vercel.com/dashboard)
2. Select your `clinicalscribe` project
3. Go to **Settings** â†’ **Environment Variables**
4. Add new variable:
   ```
   RENDER_PDF_URL=https://clinicalscribe-pdf-service.onrender.com/api/pdf/render
   ```
5. Apply to: **Production, Preview, Development**

### 3. Redeploy Main App
```bash
# Trigger a new Vercel deployment
git commit --allow-empty -m "chore: trigger vercel redeploy with render url"
git push
```

## ğŸ§ª Test the Service

### Test Render Endpoint Directly
```bash
curl -X POST https://clinicalscribe-pdf-service.onrender.com/api/pdf/render \
  -H "Content-Type: application/json" \
  -d '{"html":"<h1>Test PDF</h1><p>Generated by Render</p>"}' \
  --output test.pdf
```

This should download a valid `test.pdf`.

### Test Through Your App
1. Generate a SOAP note in your ClinicalScribe app
2. Check the response headers for `x-render-mode: remote`
3. Verify the PDF downloads correctly

## ğŸ“Š How It Works Now

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User generates SOAP note                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Vercel (ClinicalScribe)                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Try local PDF generation (chrome-aws-lambda)            â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                   â”‚                                           â”‚
â”‚                   â”œâ”€ Success? â†’ Return PDF âœ…                â”‚
â”‚                   â”‚                                           â”‚
â”‚                   â””â”€ Failed? â†’ Call Render fallback          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Render (PDF Service)                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Full Linux VM with Chromium installed                  â”‚ â”‚
â”‚ â”‚ Puppeteer generates PDF                                 â”‚ â”‚
â”‚ â”‚ Returns PDF with x-render-mode: remote header          â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ’° Cost Considerations

### Free Tier
- âœ… Service sleeps after 15 minutes of inactivity
- âš ï¸ First request after sleep takes ~30 seconds to wake up
- âœ… Good for development/testing

### Starter Tier ($7/month)
- âœ… Always on (no cold starts)
- âœ… Faster response times
- âœ… Better for production

## ğŸ› Troubleshooting

### "Deploy failed" still happening?
- Verify **Root Directory** is set to `render-pdf-service`
- Check build logs for specific errors
- Ensure `apt.txt` is present (Chromium dependencies)

### Service returns 500 error?
- Check Render logs for Puppeteer errors
- Verify all Chromium args are present in `server.js`
- Ensure `apt.txt` packages are installed

### PDFs not generating?
- Test the endpoint directly with curl (see above)
- Check `RENDER_PDF_URL` is set correctly in Vercel
- Verify your main app is calling the fallback correctly

## ğŸ¯ Success Criteria

âœ… Render service deploys without errors  
âœ… Health check endpoint returns "âœ… ClinicalScribe PDF Service Online"  
âœ… PDF endpoint generates valid PDFs  
âœ… Main app uses fallback when local generation fails  
âœ… Firestore logs show `renderMode: "remote"` for fallback PDFs  

## ğŸ“ Next Steps

1. âœ… Deploy to Render (follow steps above)
2. âœ… Add `RENDER_PDF_URL` to Vercel
3. âœ… Test PDF generation
4. âœ… Monitor Render logs for any issues
5. Consider upgrading to Starter tier if cold starts are problematic

---

**Need help?** Check the logs:
- Render: Dashboard â†’ Your Service â†’ Logs
- Vercel: Dashboard â†’ Your Project â†’ Deployments â†’ View Function Logs
